---
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";
import Link from "@/components/ui/Link.astro";

import { buildMenu } from "@/lib/utils";
import { menuConfig } from "config";

const pathname: string = new URL(Astro.request.url).pathname;
const firstSegment = pathname.split("/")[1];
const topLevelSection = menuConfig[firstSegment] ? firstSegment : "home";

const docs = await getCollection("docs");
const sectionMenuConfig = menuConfig[topLevelSection];
const menu = sectionMenuConfig ? buildMenu(docs, sectionMenuConfig.items) : [];

const { class: className } = Astro.props;
---

<div
  class={`flex flex-col gap-1 m-0 w-full h-full md:border-r-[1px] border-border ${className}`}
>
  <!-- Top-level section links (Home, Guides, etc.) -->
  <div class="p-4 flex flex-col gap-1 border-b-[1px] border-border">
    {
      Object.entries(menuConfig).map(([sectionKey, sectionValue]) => {
        const firstGroup = Object.values(sectionValue.items)[0];
        const firstItem = firstGroup?.items?.[0] ?? "/";
        const isActive = topLevelSection === sectionKey;

        const linkClass = `h-8! ${
          isActive
            ? "font-bold text-background-base! bg-accent-primary hover:bg-accent-primary/80!"
            : ""
        }`;

        return (
          <Link href={firstItem} class={linkClass} key={sectionKey}>
            <span class="flex items-center gap-2">
              {sectionValue.icon && <Icon name={sectionValue.icon} />}
              {sectionValue.label ?? sectionKey}
            </span>
          </Link>
        );
      })
    }
  </div>

  <!-- In-section menu -->
  <div class="flex flex-col gap-4 overflow-y-scroll py-4 pl-4 pr-[12px]">
    {
      menu.map((section) => (
        <div class="flex flex-col gap-2">
          <div class="flex flex-row px-4 gap-2 items-center">
            {section.icon && <Icon name={section.icon} />}
            <p class="text-text-primary font-medium mt-0!">{section.title}</p>
          </div>
          <div class="flex flex-col gap-1">
            {section.items.map((item) => {
              const isActive = pathname === item.href;
              const classNameLink = isActive
                ? "text-text-primary! bg-background-surface!"
                : "text-text-secondary! hover:text-accent-primary! hover:bg-transparent!";
              return (
                <Link
                  href={item.href}
                  class={`h-6! ${classNameLink}`}
                  key={item.href}
                >
                  {item.title}
                </Link>
              );
            })}
          </div>
        </div>
      ))
    }
  </div>
</div>
